---
title: "Merging Data Sets"
author: "Hun Lee (sl4836), Jimmy Kelliher (jmk2303), Tanvir Khan (tk2886), Tucker Morgan (tlm2152), Zachary Katz (zak2132)"
date: "11/20/2021"
output: github_document
---

```{r}
library(tidyverse)

library(janitor)

```

Below, we're reading in ZCTA death rate in NYC. The second file shows the ZCTA and puma and percentages that is used to approximate specific calculations such as ZCTA to PUMA (death rate)
```{r}
death_data <- read.csv("./data/nyc_death_rate_zcta.csv")

zcta_to_puma <- read.csv("./data/zcta_puma_cross.csv")

```

Below, we're reading in ZCTA health outcome data in NYC including death rate, hospitalization rate, and vaccination rate by ZCTA. The `zcta_puma_cross` file shows ZCTA and PUMA ID values in NYC along with percentages of overlapping geographies, which we will use to approximate values, such as hospitalization rate, from the ZCTA level to the PUMA level. The `zcta_zip_cross` file shows how each zip code aggregates to a ZCTA.
```{r importing data sets, message = FALSE}
death_data <- read_csv("./data/nyc_death_rate_zcta.csv")
hosp_data <- read_csv("./data/nyc_hosp_rate_zcta.csv")
vacc_data <- read_csv("./data/nyc_vacc_zcta.csv")

zcta_puma_cross <- read_csv("./data/zcta_puma_cross.csv")
zcta_zip_cross <- read.csv("./data/zcta_zip_cross.csv")

```

Below, we are calculating the mean death rate and hospitalization rate for each ZCTA. These data are presented over the time interval from March 2020 to September 2021. We will take the mean rate across these months to use in our analysis.
```{r cleaning death data}
death_data_clean <-
  death_data %>% 
  janitor::clean_names() %>%
  select(deathrate_10001:deathrate_11697) %>%
  pivot_longer(deathrate_10001:deathrate_11697, 
               names_to = "zcta", 
               values_to = "death_rate", 
               names_prefix = "deathrate_") %>%
  group_by(zcta) %>%
  summarise(death_rate_mean = 
              mean(death_rate, na.rm = T)) # Mean removes NA values here, may want to replace above

rm(death_data) # This removes the raw data, but fine to take out this line of code
```

```{r cleaning hospitalization data}
hosp_data_clean <- 
  hosp_data %>% 
  janitor::clean_names() %>%
  select(hosprate_10001:hosprate_11697) %>%
  pivot_longer(hosprate_10001:hosprate_11697, 
               names_to = "zcta", 
               values_to = "hosp_rate", 
               names_prefix = "hosprate_") %>%
  group_by(zcta) %>%
  summarise(hosp_rate_mean = 
              mean(hosp_rate, na.rm = T)) # Mean removes NA values here, may want to replace above

rm(hosp_data) # Fine to remove this line of code
```

Below, we clean `vacc_data` and extract only the percentage of partially or fully vaccinated individuals in each ZCTA as of November 16, 2021.
```{r cleaning vaccination data}
vacc_data_clean <- 
  vacc_data %>% 
  janitor::clean_names() %>% 
  select(modzcta, perc_1plus) %>% # We can make changes here if we want to include other variables
  rename(zcta = modzcta) %>% 
  mutate(zcta = as.character(zcta))

rm(vacc_data) # Fine to remove this line of code
```

The cleaned and merged data sets:
```{r showing cleaned data sets}
merged_outcomes <- 
  merge(death_data_clean, hosp_data_clean, by = "zcta")

merged_outcomes <- 
  merge(merged_outcomes, vacc_data_clean, by = "zcta")

head(merged_outcomes) # One potential issue here is that vaccination rate exceeds 100% in some places
```

Below, the code shows the ZCTA and PUMA ID numbers, `per_in_puma` - the percentage of the ZCTA in the associated PUMA,  and `per_of_puma` - the percentage of the PUMA that is occupied by the specified ZCTA. 
```{r cleaning ZCTA - PUMA crosswalk}
zcta_puma_clean <-
  zcta_puma_cross %>% 
  mutate(zcta10 = 
           as.character(zcta10)) %>%
  select(zcta10 , puma10, per_in_puma, per_of_puma) %>%
  rename(zcta = zcta10) 

head(zcta_puma_clean)
rm(zcta_puma_cross) # Fine to remove this line of code
```

Below, we calculate `weighted_death_rate` and `weighted_hosp_rate` for each PUMA by the following steps. 
  1. The `death_rate` or `hosp_rate` from each ZCTA is multiplied by the percentage of the ZCTA that is in the corresponding PUMA (`per_in_puma`).
  2. The resulting product is then multiplied by `per_in_puma` which represents the percentage of the total PUMA that the specified ZCTA occupies.
  3. The resulting weighted products are summed for each PUMA to obtain the total `weighted_death_rate` and `weighted_hosp_rate` for each PUMA.

```{r}
merge(zcta_puma_clean, merged_outcomes, by = "zcta")
```


```{r calculating PUMA rates}
outcome_puma <- 
  merge(zcta_puma_clean, merged_outcomes, by = "zcta") %>%
  mutate(weighted_death_rate =  
           death_rate_mean * per_in_puma * per_of_puma,
         weighted_hosp_rate =
           hosp_rate_mean * per_in_puma * per_of_puma,
         weighted_vacc_rate = 
           perc_1plus * per_in_puma * per_of_puma) %>% 
  select(weighted_death_rate,
         weighted_hosp_rate,
         weighted_vacc_rate,
         puma10) %>%
  group_by(puma10) %>%
  summarise(puma_death_rate = sum(weighted_death_rate),
            puma_hosp_rate = sum(weighted_hosp_rate),
            puma_vacc_rate = sum(weighted_vacc_rate)) 
  
outcome_puma %>% pull(puma10) %>% n_distinct() # merged result has the same number of puma as that of original number!

head(outcome_puma)
```


### Zip to Zcta
```{r}
#tidying zcta_zip_cross data
zip_to_zcta <-
  zcta_zip_cross %>%
  select(zipcode, zcta5) %>%
  rename(zcta = zcta5) %>% 
  mutate(zcta = as.character(zcta))

#selecting needed variables from zcta_puma_clean data
zcta_puma_3 <- 
  zcta_puma_clean %>%
  select(zcta, puma10)
```

### try to see what zcta values are different
```{r}
a <- zip_to_zcta %>% mutate(zcta = as.numeric(zcta)) %>% pull(zcta) %>% sort() %>% unique()

b <- zcta_puma_3 %>% mutate(zcta = as.numeric(zcta)) %>% pull(zcta) %>% sort() %>% unique()


# The issue here is that we have 214 unique ZCTAs in the zip to ZCTA crosswalk file (a), but
# only 211 in the ZCTA to PUMA crosswalk file (b).
# The missing ZCTAs are: 11001, 11003, 11040. We should find out which zip codes correspond to these
# missing ZCTAs in the nyc_broadband data set, and see what the data is.

a[which((a %in% b) == FALSE)] # showing missing 3 ZCTAs

result_zip_to_zcta <- 
  merge(zip_to_zcta, zcta_puma_3, by = "zcta") %>% relocate(zipcode) #turning zip into zcta 

result_zip_to_zcta %>% pull(zcta) %>% n_distinct() #count the number of unique ZCTAs

result_zip_to_zcta #showing the result

```





