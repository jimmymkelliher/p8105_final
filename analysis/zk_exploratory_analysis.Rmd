---
title: "Initial Exploratory Analysis"
author: 'Zachary Katz'
date: "11/24/2021"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

<!------------------------------------------------------------------------------
Preamble
------------------------------------------------------------------------------->

```{r, echo = FALSE, message = FALSE, warning = FALSE}
# load necessary packages
library(tidyverse)

# set knitr defaults
knitr::opts_chunk$set(
    echo      = TRUE
  , message   = FALSE
  , fig.width = 6
  , fig.asp   = .6
  , out.width = "90%"
)

# set theme defaults
theme_set(
  theme_bw() +
  theme(
    legend.position = "bottom"
    , plot.title    = element_text(hjust = 0.5)
    , plot.subtitle = element_text(hjust = 0.5)    
    , plot.caption  = element_text(hjust = 0.0)
  )
)

# set color scale defaults
options(
    ggplot2.continuous.colour = "viridis"
  , ggplot2.continuous.fill   = "viridis"
)
scale_colour_discrete = scale_colour_viridis_d
scale_fill_discrete   = scale_fill_viridis_d
```

<!------------------------------------------------------------------------------
Overview
------------------------------------------------------------------------------->

# Unzipping the Census Data

```{r}
jimzip <- function(csv_file, path) {
  # create full path to csv file
  full_csv <- paste0(path, "/", csv_file)
  # append ".zip" to csv file
  zip_file <- paste0(full_csv, ".zip")
  # unzip file
  unzip(zip_file)
  # read csv
  data_extract <- read_csv(csv_file)
  # be sure to remove file once unzipped (it will live in working directory)
  on.exit(file.remove(csv_file))
  # output data
  data_extract
}

census_data <- jimzip("census_filtered.csv", "./data")
head(census_data) %>%  knitr::kable()
```

# Merging the Outcome Data

```{r}
health_data <-
  read_csv("./data/outcome_puma.csv") %>%
  rename(puma = puma10)

merged_data <- merge(census_data, health_data, by = "puma")
rm(census_data)

head(merged_data) %>% knitr::kable()
```

## Cleaning the Data

```{r}
# Clean the merged census and outcomes data
cleaned_data = 
  merged_data %>% 
  # Remove variables less useful for analysis, including ones with high correlation with remaining variables
  select(-multyear, -ancestr1, -ancestr2, -labforce, -occ, -ind, -incwage, -occscore, -pwpuma00, -ftotinc, -hcovpub) %>% 
  # Remove duplicate rows
  distinct() %>% 
  # Rename variables
  rename(
    borough = countyfip,
    has_broadband = cihispeed,
    birthplace = bpl,
    years_in_usa = yrsusa1,
    education = educd,
    employment = empstat,
    personal_income = inctot,
    work_transport = tranwork,
    household_income = hhincome,
    on_foodstamps = foodstmp,
    family_size = famsize,
    num_children = nchild,
    US_citizen = citizen,
    puma_vacc_rate = puma_vacc_per,
    on_welfare = incwelfr,
    poverty_threshold = poverty
  ) %>% 
  # Recode variables according to data dictionary
  mutate(
    # Researched mapping for county
    borough = recode(
      borough,
      "5" = "Bronx",
      "47" = "Brooklyn",
      "61" = "Manhattan",
      "81" = "Queens",
      "85" = "Staten Island"
    ),
    rent = ifelse(
      rent == 9999, 0,
      rent
    ),
    household_income = ifelse(
      household_income %in% c(9999998,9999999), NA,
      household_income
    ),
    on_foodstamps = recode(
      on_foodstamps,
      "1" = "No",
      "2" = "Yes"
    ),
    has_broadband = case_when(
      has_broadband == "20" ~ "No",
      has_broadband != "20" ~ "Yes"
    ),
    sex = recode(
      sex,
      "1" = "Male",
      "2" = "Female"
    ),
    # Collapse Hispanic observation into race observation
    race = case_when(
      race == "1" ~ "White",
      race == "2" ~ "Black",
      race == "3" ~ "American Indian",
      race %in% c(4,5,6) ~ "Asian and Pacific Islander",
      race == 7 & hispan %in% c(1,2,3,4) ~ "Hispanic",
      race == 7 & hispan %in% c(0,9) ~ "Other",
      race %in% c(8,9) ~ "2+ races"
    ),
    birthplace = case_when(
      birthplace %in% 1:120 ~"US",
      birthplace %in% 121:950 ~ "Non-US",
      birthplace == 999 ~"Unknown"
    ),
    US_citizen = case_when(
      US_citizen %in% c(1,2) ~ "Yes",
      US_citizen %in% 3:8 ~"No",
      US_citizen %in% c(0,9) ~ "Unknown"
    ),
    # Chose languages based on highest frequency observed
    language = case_when(
      language == "1" ~ "English",
      language == "12" ~ "Spanish",
      language == "43" ~ "Chinese",
      language == "0" ~ "Unknown",
      language == "31" ~ "Hindi",
      !language %in% c(1,12,43,0,31) ~ "Other"
    ),
    # Collapse multiple health insurance variables into single variable
    health_insurance = case_when(
      hcovany == 1 ~ "None",
      hcovany == 2 && hcovpriv == 2 ~ "Private",
      hcovany == 2 && hcovpriv == 1 ~ "Public"
    ),
    education = case_when(
      education %in% 2:61 ~ "Less Than HS Graduate",
      education %in% 62:64 ~ "HS Graduate",
      education %in% 65:100 ~ "Some College",
      education %in% 110:113 ~ "Some College",
      education == 101 ~ "Bachelor's Degree",
      education %in% 114:116 ~ "Post-Graduate Degree",
      education %in% c(0,1,999) ~ "Unknown"
    ),
    employment = case_when(
      employment %in% c(0,3) ~ "Not in labor force",
      employment == 1 ~ "Employed",
      employment == 2 ~ "Unemployed"
    ),
    personal_income = ifelse(
      personal_income %in% c(9999998,9999999), NA,
      personal_income
    ),
    household_income = ifelse(
      household_income %in% c(9999998,9999999), NA,
      household_income
    ),
    on_welfare = case_when(
      on_welfare > 0 ~ "Yes",
      on_welfare == 0 ~ "No"
    ), 
    poverty_threshold = case_when(
      poverty_threshold >= 100 ~ "Above",
      poverty_threshold < 100 ~ "Below"
    ),
    work_transport = case_when(
      work_transport %in% c(31:37, 39) ~ "Public Transit",
      work_transport %in% c(10:20, 38) ~ "Private Vehicle",
      work_transport == 50 ~ "Bicycle",
      work_transport == 60 ~ "Walking",
      work_transport == 80 ~ "Worked From Home",
      work_transport %in% c(0, 70) ~ "Other"
    )
  ) %>% 
  # Convert hospitalization and death rates to pure percentages to match vax rate
  mutate(
    puma_hosp_rate = puma_hosp_rate / 1000,
    puma_death_rate = puma_death_rate / 1000
  ) %>% 
  # Eliminate columns no longer needed after transformation
  select(-hispan, -hcovany, -hcovpriv) %>% 
  # Relocate new columns
  relocate(health_insurance, .before = personal_income) %>% 
  relocate(poverty_threshold, .before = work_transport) %>% 
  relocate(on_welfare, .before = poverty_threshold) %>% 
  relocate(perwt, .before = cluster) %>% 
  # Create factor variables where applicable
  mutate(across(.cols = c(puma, borough, on_foodstamps, has_broadband, sex, race, birthplace, US_citizen, language, health_insurance, education, employment, on_welfare, poverty_threshold, work_transport), as.factor))

```

The Census also doesn't reach everyone; it samples the population. As a result, we need to weight our statistics by how many households look like a particular household observed, or how many persons look like a particular person observed. We also want to group by PUMA.

```{r}
# Check total people in NYC by summing over person-weight column
sum(cleaned_data$perwt)

# Load spatstat library
library(spatstat)

# Example data frame with weightings for summary stats over each PUMA
nyc_puma_summary = cleaned_data %>% 
  # Note: do we need to filter to one individual per household for household weightings?
  group_by(puma) %>%
  summarize(
    median_household_income = weighted.median(household_income, hhwt, na.rm = TRUE),
    perc_foodstamps = sum(hhwt[on_foodstamps == "Yes"]) * 100 / sum(hhwt),
    perc_broadband = sum(hhwt[has_broadband == "Yes"]) * 100 / sum(hhwt),
    perc_male = sum(perwt[sex == "Male"]) * 100 / sum(perwt),
    median_age = weighted.median(age, perwt, na.rm = TRUE),
    perc_white = sum(perwt[race == "White"]) * 100 / sum(perwt),
    perc_foreign_born = sum(perwt[birthplace == "Non-US"]) * 100 / sum(perwt),
    perc_citizen = sum(perwt[US_citizen == "Yes"]) * 100 / sum(perwt),
    median_years_in_usa = weighted.median(years_in_usa, perwt, na.rm = TRUE),
    perc_english = sum(perwt[language == "English"]) * 100 / sum(perwt),
    perc_college = sum(perwt[education %in% c("Some College", "Bachelor's Degree", "Post-Graduate Degree")]) * 100 / sum(perwt),
    perc_unemployed = sum(perwt[employment == "Unemployed"]) * 100 / sum(perwt),
    perc_insured = sum(perwt[health_insurance %in% c("Private", "Public")]) * 100 / sum(perwt),
    median_personal_income = weighted.median(personal_income, perwt, na.rm = TRUE),
    perc_welfare = sum(perwt[on_welfare == "Yes"]) * 100 / sum(perwt),
    perc_poverty = sum(perwt[poverty_threshold == "Below"]) * 100 / sum(perwt),
    perc_public_transit = sum(perwt[work_transport == "Public Transit"]) * 100 / sum(perwt),
    covid_hosp_rate = median(puma_hosp_rate),
    covid_vax_rate = median(puma_vacc_rate),
    covid_death_rate = median(puma_death_rate)
  )

# View summary data across PUMAs
nyc_puma_summary %>% 
  View()
```

## Exploratory Analysis

#### Correlations between covariates and outcomes

```{r}
library(reshape2)
library(rstatix)
library(patchwork)

# Reorder function
reorder_cormat <- function(cormat){
  # Use correlation between variables as distance
  dd <- as.dist((1-cormat)/2)
  hc <- hclust(dd)
  cormat <-cormat[hc$order, hc$order]
}

# Create correlation matrix
# Show all correlation values
nyc_puma_summary %>% 
  select(-puma) %>% 
  cor_mat() %>% 
  cor_gather() %>% 
  filter(var1 %in% c("covid_hosp_rate", "covid_death_rate", "covid_vax_rate")) %>% 
  filter(!var2 %in% c("covid_hosp_rate", "covid_death_rate", "covid_vax_rate")) %>% 
  ggplot(aes(x = var1, y = var2, fill = cor)) + 
  geom_tile(color = "white") +  
  scale_x_discrete(
    labels = c("Death Rate", "Hosp Rate", "Vax Rate")
  ) + 
  geom_text(
    aes(var1, var2, label = cor),
    color = "white",
    size = 4
  )

# Alternative correlation matrix
# Show only correlation values where p < 0.01
nyc_puma_summary %>% 
  select(-puma) %>% 
  cor_mat() %>% 
  cor_gather() %>% 
  filter(var1 %in% c("covid_hosp_rate", "covid_death_rate", "covid_vax_rate")) %>% 
  filter(!var2 %in% c("covid_hosp_rate", "covid_death_rate", "covid_vax_rate")) %>% 
  mutate(
    sig_p = ifelse(p < 0.01, T, F),
    p_if_sig = ifelse(p < 0.01, p, NA),
    r_if_sig = ifelse(p < 0.01, cor, NA)
  ) %>% 
  ggplot(aes(
    x = var1, 
    y = var2, 
    fill = cor,
    label = round(r_if_sig, 2))) + 
  geom_tile(color = "white") +  
  scale_x_discrete(
    labels = c("Death Rate", "Hosp Rate", "Vax Rate")
  ) + 
  geom_text(
    color = "white",
    size = 4
  )

# Another alternative using size to represent correlation
nyc_puma_summary %>% 
  select(-puma) %>% 
  cor_mat() %>% 
  cor_gather() %>% 
  filter(var1 %in% c("covid_hosp_rate", "covid_death_rate", "covid_vax_rate")) %>% 
  filter(!var2 %in% c("covid_hosp_rate", "covid_death_rate", "covid_vax_rate")) %>% 
  mutate(
    sig_p = ifelse(p < 0.01, T, F),
    p_if_sig = ifelse(p < 0.01, p, NA),
    r_if_sig = ifelse(p < 0.01, cor, NA)
  ) %>% 
  ggplot(aes(
    x = var1,
    y = var2,
    color = cor,
    label = round(r_if_sig, 2)
  )) + 
  geom_tile(col = "black", fill = "white") + 
  geom_point(aes(size = abs(cor)), shape = 15) + 
  geom_text(color = "white", size = 2) + 
  scale_x_discrete(
    labels = c("Death Rate", "Hosp Rate", "Vax Rate")
  )

# Notes for later:
# Reorder matrix?

# Reorder function
reorder_cormat <- function(cormat){
  # Use correlation between variables as distance
  dd <- as.dist((1-cormat)/2)
  hc <- hclust(dd)
  cormat <-cormat[hc$order, hc$order]
}
```

#### Outcome distributions across PUMAs

```{r}
# Add county to each PUMA observation
nyc_puma_summary_counties = 
  nyc_puma_summary %>% 
  mutate(
    borough = as.factor(case_when(
      str_detect(puma, "37") ~ "Bronx",
      str_detect(puma, "38") ~ "Manhattan",
      str_detect(puma, "39") ~ "Staten Island",
      str_detect(puma, "40") ~ "Brooklyn",
      str_detect(puma, "41") ~ "Queens")
    )
  )

# Hospitalization rates across PUMAs, colored by borough
PUMA_hosp = nyc_puma_summary_counties %>% 
  ggplot(aes(x = fct_reorder(puma, covid_hosp_rate), y = covid_hosp_rate)) + 
  geom_point(aes(color = borough)) + 
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) + 
  labs(
    x = "PUMA",
    y = "COVID hospitalization rate"
  )

# Death rates across PUMAs, colored by borough
PUMA_death = nyc_puma_summary_counties %>% 
  ggplot(aes(x = fct_reorder(puma, covid_death_rate), y = covid_death_rate)) + 
  geom_point(aes(color = borough)) + 
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) + 
  labs(
    x = "PUMA",
    y = "COVID death rate"
  )

# Vax rates across PUMAs, colored by borough
PUMA_vax = nyc_puma_summary_counties %>% 
  ggplot(aes(x = fct_reorder(puma, covid_vax_rate), y = covid_vax_rate)) + 
  geom_point(aes(color = borough)) + 
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) + 
  labs(
    x = "PUMA",
    y = "COVID vax rate"
  )

(PUMA_hosp + PUMA_death) / PUMA_vax
```

``` {r}
# Alternatively, can rank 10 "worst" and "best" for each to see how they compare

# PUMAs with highest hosp rates
PUMA_hosp_highest10 = nyc_puma_summary_counties %>% 
  arrange(desc(covid_hosp_rate)) %>% 
  mutate(
    rank = rank(desc(covid_hosp_rate))
  ) %>% 
  filter(rank < 11) %>% 
  ggplot(aes(x = fct_reorder(puma, desc(covid_hosp_rate)), y = covid_hosp_rate)) + 
  geom_bar(stat = "identity", aes(fill = borough)) + 
  labs(
    x = "PUMA",
    y = "COVID hospitalization rate"
  )

# PUMAs with highest death rates
PUMA_death_highest10 = nyc_puma_summary_counties %>% 
  arrange(desc(covid_death_rate)) %>% 
  mutate(
    rank = rank(desc(covid_death_rate))
  ) %>% 
  filter(rank < 11) %>% 
  ggplot(aes(x = fct_reorder(puma, desc(covid_death_rate)), y = covid_death_rate)) + 
  geom_bar(stat = "identity", aes(fill = borough)) + 
  labs(
    x = "PUMA",
    y = "COVID death rate"
  )

# PUMAs with lowest vax rates
PUMA_vax_lowest10 = nyc_puma_summary_counties %>% 
  arrange(covid_vax_rate) %>% 
  mutate(
    rank = rank(covid_vax_rate)
  ) %>% 
  filter(rank < 11) %>% 
  ggplot(aes(x = fct_reorder(puma, covid_vax_rate), y = covid_vax_rate)) + 
  geom_bar(stat = "identity", aes(fill = borough)) + 
  labs(
    x = "PUMA",
    y = "COVID vax rate"
  )

(PUMA_hosp_highest10 + PUMA_death_highest10) / PUMA_vax_lowest10

# PUMAs with lowest hosp rates
PUMA_hosp_lowest10 = nyc_puma_summary_counties %>% 
  arrange(covid_hosp_rate) %>% 
  mutate(
    rank = rank(desc(covid_hosp_rate))
  ) %>% 
  filter(rank < 11) %>% 
  ggplot(aes(x = fct_reorder(puma, covid_hosp_rate), y = covid_hosp_rate)) + 
  geom_bar(stat = "identity", aes(fill = borough)) +
  labs(
    x = "PUMA",
    y = "COVID hospitalization rate"
  )

# PUMAs with lowest death rates
PUMA_death_lowest10 = nyc_puma_summary_counties %>% 
  arrange(covid_death_rate) %>% 
  mutate(
    rank = rank(desc(covid_death_rate))
  ) %>% 
  filter(rank < 11) %>% 
  ggplot(aes(x = fct_reorder(puma, covid_death_rate), y = covid_death_rate)) + 
  geom_bar(stat = "identity", aes(fill = borough)) + 
  labs(
    x = "PUMA",
    y = "COVID death rate"
  )

# PUMAs with highest vax rates
PUMA_vax_highest10 = nyc_puma_summary_counties %>% 
  arrange(desc(covid_vax_rate)) %>% 
  mutate(
    rank = rank(desc(covid_vax_rate))
  ) %>% 
  filter(rank < 11) %>% 
  ggplot(aes(x = fct_reorder(puma, desc(covid_vax_rate)), y = covid_vax_rate)) + 
  geom_bar(stat = "identity", aes(fill = borough)) + 
  labs(
    x = "PUMA",
    y = "COVID vax rate"
  )

(PUMA_hosp_lowest10 + PUMA_death_lowest10) / PUMA_vax_highest10
```

```{r}
# Can also determine "conversion rates", i.e. ratios of deaths to hospitalizations
# Here's an example
PUMA_ratio = nyc_puma_summary_counties %>% 
  mutate(
    ratio_death_to_hosp = covid_death_rate / covid_hosp_rate
  ) %>% 
  arrange(desc(ratio_death_to_hosp)) %>% 
  ggplot(aes(x = fct_reorder(puma, ratio_death_to_hosp), y = ratio_death_to_hosp)) + 
  geom_point(aes(color = borough)) + 
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) + 
  labs(
    x = "PUMA",
    y = "Ratio of Death Rate to Hospitalization Rate"
  )
  
# First with the "worst" 10
PUMA_ratio_worst = nyc_puma_summary_counties %>% 
  mutate(
    ratio_death_to_hosp = covid_death_rate / covid_hosp_rate,
    rank = rank(desc(ratio_death_to_hosp))
  ) %>% 
  filter(rank < 11) %>% 
  ggplot(aes(x = fct_reorder(puma, desc(ratio_death_to_hosp)), y = ratio_death_to_hosp)) + 
  geom_bar(stat = "identity", aes(fill = borough)) + 
  labs(
    x = "Worst 10 PUMAs",
    y = "Ratio of Death Rate to Hospitalization Rate"
  )

# Then wtih the "best" 10
PUMA_ratio_best = nyc_puma_summary_counties %>% 
  mutate(
    ratio_death_to_hosp = covid_death_rate / covid_hosp_rate,
    rank = rank(ratio_death_to_hosp)
  ) %>% 
  filter(rank < 11) %>% 
  ggplot(aes(x = fct_reorder(puma, ratio_death_to_hosp), y = ratio_death_to_hosp)) + 
  geom_bar(stat = "identity", aes(fill = borough)) + 
  labs(
    x = "Best 10 PUMAs",
    y = "Ratio of Death Rate to Hospitalization Rate"
  )

PUMA_ratio_worst + PUMA_ratio_best
```

#### Outcome distributions across boroughs

```{r}
# Outcomes distribution by borough

# Hospitalizations across PUMAs in each borough
hosps = nyc_puma_summary_counties %>% 
  ggplot(aes(x = reorder(borough, covid_hosp_rate, FUN = "median"), y = covid_hosp_rate)) + 
  geom_boxplot(aes(fill = borough)) + 
  labs(
    x = "Borough",
    y = "COVID hospitalization rate"
  )

# Deaths across PUMAs in each borough
deaths = nyc_puma_summary_counties %>% 
  ggplot(aes(x = reorder(borough, covid_death_rate, FUN = "median"), y = covid_death_rate)) + 
  geom_boxplot(aes(fill = borough)) + 
  labs(
    x = "Borough",
    y = "COVID death rate"
  )

# Vax across PUMAs in each borough
vax = nyc_puma_summary_counties %>% 
  ggplot(aes(x = reorder(borough, covid_vax_rate, FUN = "median"), y = covid_vax_rate)) + 
  geom_boxplot(aes(fill = borough)) + 
  labs(
    x = "Borough",
    y = "COVID vax rate"
  )

hosps + deaths + vax

# Ratio of death rate to hosp rate in each borough
nyc_puma_summary_counties %>% 
  mutate(
    ratio = covid_death_rate / covid_hosp_rate
  ) %>% 
  ggplot(aes(x = reorder(borough, ratio, FUN = "median"), y = ratio)) + 
  geom_boxplot(aes(fill = borough)) + 
  labs(
    x = "Borough",
    y = "COVID death to hosp ratio"
  )
  
```

#### Demographics vs Outcome (examples)

```{r}
# Sex vs Hospitalization
nyc_puma_summary_counties %>% 
  ggplot(aes(
    x = perc_male,
    y = covid_hosp_rate
  )) + 
  geom_point() + 
  geom_smooth()

# Race vs Hospitalization
nyc_puma_summary_counties %>% 
  ggplot(aes(
    x = perc_white,
    y = covid_hosp_rate
  )) + 
  geom_point() + 
  geom_smooth()

# Age vs Hospitalization
nyc_puma_summary_counties %>% 
  ggplot(aes(
    x = median_age,
    y = covid_hosp_rate
  )) + 
  geom_point() + 
  geom_smooth()
```

Gender seems pretty irrelevant. Hospitalization and % white seem negatively associated, whereas hospitalization and median age seem positively associated.

#### SES vs Outcome (examples)

```{r}
# Household income vs Vaccination
nyc_puma_summary_counties %>% 
  ggplot(aes(
    x = median_household_income,
    y = covid_vax_rate
  )) + 
  geom_point() + 
  geom_smooth()

# Health insurance vs Vaccination
nyc_puma_summary_counties %>% 
  ggplot(aes(
    x = perc_insured,
    y = covid_vax_rate
  )) + 
  geom_point() + 
  geom_smooth()

# Foodstamps vs Vaccination
nyc_puma_summary_counties %>% 
  ggplot(aes(
    x = perc_foodstamps,
    y = covid_vax_rate
  )) + 
  geom_point() + 
  geom_smooth()

# Welfare vs Vaccination
nyc_puma_summary_counties %>% 
  ggplot(aes(
    x = perc_welfare,
    y = covid_vax_rate
  )) + 
  geom_point() + 
  geom_smooth()
```

Foodstamps, welfare, poverty quite negatively associated with COVID vax rate, whereas household income positively associated with vax rate.

```{r}
# Another example of scatter plot with R, p values
library(ggpubr)
ggscatter(nyc_puma_summary_counties, x = "perc_college", y = "covid_vax_rate", cor.coef = TRUE, cor.method = "pearson", add = "reg.line") + 
  geom_point(aes(color = borough))
```

#### Other Explorations

Income vs outcomes, colored by college education

```{r}
nyc_puma_summary_counties %>% 
  ggplot(aes(x = median_household_income, y = covid_hosp_rate)) + 
  geom_point(aes(color = perc_college))

nyc_puma_summary_counties %>% 
  ggplot(aes(x = median_household_income, y = covid_vax_rate)) + 
  geom_point(aes(color = perc_college))

nyc_puma_summary_counties %>% 
  ggplot(aes(x = median_household_income, y = covid_death_rate)) + 
  geom_point(aes(color = perc_college))

# Try size?
nyc_puma_summary_counties %>% 
  ggplot(aes(x = median_household_income, y = covid_death_rate)) + 
  geom_point(aes(size = perc_college))
```

Signifiers of low SES vs vaccination, colored by % white

```{r}
nyc_puma_summary_counties %>% 
  ggplot(aes(x = perc_foodstamps, y = covid_vax_rate)) +
  geom_point(aes(color = perc_white))

nyc_puma_summary_counties %>% 
  ggplot(aes(x = perc_welfare, y = covid_vax_rate)) +
  geom_point(aes(color = perc_white))

nyc_puma_summary_counties %>% 
  ggplot(aes(x = perc_poverty, y = covid_vax_rate)) +
  geom_point(aes(color = perc_white))

nyc_puma_summary_counties %>% 
  ggplot(aes(x = perc_unemployed, y = covid_vax_rate)) +
  geom_point(aes(color = perc_white))

# Try size?
nyc_puma_summary_counties %>% 
  ggplot(aes(x = perc_foodstamps, y = covid_vax_rate)) +
  geom_point(aes(size = perc_white))
```



```{r}
nyc_puma_summary_counties %>% 
  pivot_longer(
    cols = starts_with("covid"),
    values_to = 'outcome_rate'
  ) %>% 
  filter(!name == "covid_vax_rate") %>% 
  ggplot(
    aes(
      x = puma,
      y = outcome_rate
    )
  ) + 
  geom_point() + 
  facet_grid(name ~ borough)

# Vax on different scale (%)
nyc_puma_summary_counties %>% 
  pivot_longer(
    cols = starts_with("covid"),
    values_to = 'outcome_rate'
  ) %>% 
  filter(name == "covid_vax_rate") %>% 
  ggplot(
    aes(
      x = puma,
      y = outcome_rate
    )
  ) + 
  geom_point() + 
  facet_grid(name ~ borough)
```

COVID death rates are much more consistent across PUMAs within a given county, whereas hospitalization and vax rates have more dispersion (variance).

```{r}
# Ratio of hosp rate to death rate
nyc_puma_summary_counties %>% 
  mutate(
    ratio = covid_hosp_rate / covid_death_rate
  ) %>% 
  ggplot(aes(x = fct_reorder(puma, ratio), y = ratio)) + 
  geom_point(aes(color = borough))

# Ratio of hosp rate to vax rate
nyc_puma_summary_counties %>% 
  mutate(
    ratio = covid_hosp_rate / covid_vax_rate
  ) %>% 
  ggplot(aes(x = fct_reorder(puma, ratio), y = ratio)) +
  geom_point(aes(color = borough))

# Ratio of death rate to vax rate
nyc_puma_summary_counties %>% 
  mutate(
    ratio = covid_death_rate / covid_vax_rate
  ) %>% 
  ggplot(aes(x = fct_reorder(puma, ratio), y = ratio)) +
  geom_point(aes(color = borough))

# Compare both hosp to vax and death to vax
nyc_puma_summary_counties %>% 
  mutate(
    ratio1 = covid_hosp_rate / covid_vax_rate,
    ratio2 = covid_death_rate / covid_vax_rate
  ) %>% 
  ggplot(aes(x = ratio1, y = ratio2)) + 
  geom_point(aes(color = borough)) + 
  geom_smooth()
```

Note, do we want to put hosp rate, death rate, and vax rate in standard units? (eg vax is %, the others are not)

Yes -- hosp and death rates are per 100K, so should convert to percent

```{r}
nyc_puma_summary_counties %>% 
  pivot_longer(
    cols = starts_with("covid"),
    values_to = 'outcome_rate'
  ) %>%
  filter(!name == "covid_vax_rate") %>% 
  ggplot(
    aes(
      x = outcome_rate
    )
  ) + 
  geom_density(aes(fill = name), alpha = 0.3) + 
  facet_grid(.~borough)
```

```{r}
nyc_puma_summary_counties %>% 
  View()

library(ggridges)
nyc_puma_summary_counties %>% 
  ggplot(aes(x = covid_hosp_rate, y = borough, fill = borough)) + 
  geom_density_ridges(scale = 0.6, alpha = 0.2)

nyc_puma_summary_counties %>% 
  ggplot(aes(x = covid_death_rate, y = borough, fill = borough)) + 
  geom_density_ridges(scale = 0.6, alpha = 0.2)

nyc_puma_summary_counties %>% 
  ggplot(aes(x = covid_vax_rate, y = borough, fill = borough)) + 
  geom_density_ridges(scale = 0.6, alpha = 0.2)
```

Do PUMAs with more public transit riders have higher COVID hosp rates? Death rates? (Not really)

```{r}
nyc_puma_summary_counties %>% 
  ggplot(aes(x = perc_public_transit, y = covid_hosp_rate)) + 
  geom_point() + 
  geom_smooth()

nyc_puma_summary_counties %>% 
  ggplot(aes(x = perc_public_transit, y = covid_death_rate)) + 
  geom_point() + 
  geom_smooth()
```

What about health insurance coverage? Strange curves.

```{r}
nyc_puma_summary_counties %>% 
  ggplot(aes(x = perc_insured, y = covid_hosp_rate)) + 
  geom_point() + 
  geom_smooth()

nyc_puma_summary_counties %>% 
  ggplot(aes(x = perc_insured, y = covid_death_rate)) + 
  geom_point() + 
  geom_smooth()
```

We will want to do analysis on the cleaned_data, I think.

```{r}
cleaned_data %>% 
  View()

above_below = cleaned_data %>% 
  mutate(
    above_hosp_median = as.factor(ifelse(puma_hosp_rate > median(puma_hosp_rate), 1, 0)),
    above_death_median = as.factor(ifelse(puma_death_rate > median(puma_death_rate), 1, 0)),
    above_vax_median = as.factor(ifelse(puma_vacc_rate > median(puma_vacc_rate), 1, 0))
  )

above_below %>% 
  ggplot(aes(x = household_income)) + 
  geom_density(aes(fill = above_hosp_median), alpha = 0.5)

above_below %>% 
  ggplot(aes(x = household_income)) + 
  geom_density(aes(fill = above_death_median), alpha = 0.5)

above_below %>% 
  ggplot(aes(x = household_income)) + 
  geom_density(aes(fill = above_vax_median), alpha = 0.5)

above_below %>% 
  ggplot(aes(x = household_income)) + 
  geom_density(aes(fill = above_death_median), alpha = 0.5) + 
  facet_wrap(.~borough)
```

Can we do something similar at PUMA level, recognizing small sample sizes? Maybe using bar charts?

```{r}
above_below_puma = nyc_puma_summary_counties %>% 
  mutate(
    above_hosp_median = as.factor(ifelse(covid_hosp_rate > median(covid_hosp_rate), 1, 0)),
    above_death_median = as.factor(ifelse(covid_death_rate > median(covid_death_rate), 1, 0)),
    above_vax_median = as.factor(ifelse(covid_vax_rate > median(covid_vax_rate), 1, 0))
  )

above_below_puma %>% 
  ggplot(aes(x = median_household_income)) + 
  geom_density(aes(fill = above_hosp_median), alpha = 0.5)

above_below_puma %>% 
  ggplot(aes(x = median_household_income)) + 
  geom_density(aes(fill = above_death_median), alpha = 0.5)

above_below_puma %>% 
  ggplot(aes(x = median_household_income)) + 
  geom_density(aes(fill = above_vax_median), alpha = 0.5)

above_below_puma_hh = above_below_puma %>% 
  mutate(
    above_median_hh_income = as.factor(ifelse(median_household_income > median(median_household_income), 1, 0))
  )

above_below_puma_hh %>% 
  ggplot(aes(x = above_median_hh_income, fill = above_hosp_median)) + 
  geom_bar(stat = "count")

above_below_puma_hh %>% 
  ggplot(aes(x = above_median_hh_income, fill = above_hosp_median)) + 
  geom_bar(position = "fill")

above_below_puma_hh %>% 
  ggplot(aes(x = above_median_hh_income, fill = above_death_median)) + 
  geom_bar(position = "fill")

above_below_puma_hh %>% 
  ggplot(aes(x = above_median_hh_income, fill = above_vax_median)) + 
  geom_bar(position = "fill")

above_below_puma_hh %>% 
  ggplot(aes(x = above_median_hh_income, fill = above_vax_median)) + 
  geom_bar(position = "fill") + 
  facet_wrap(.~borough)

above_below_puma_hh %>% 
  ggplot(aes(x = borough, y = sum(above_vax_median == 1), fill = above_median_hh_income)) + 
  geom_bar(position = "fill", stat = "identity")
```

Number of PUMAs per county

```{r}
nyc_puma_summary_counties %>% 
  group_by(borough) %>% 
  summarize(
    n_obs = n()
  ) %>% 
  ggplot(aes(x = borough, y = n_obs)) + 
  geom_bar(stat = "identity")
```

Number of PUMAs with above or below median outcomes by county

```{r}
above_below_puma %>% 
  group_by(borough) %>% 
  ggplot(
    aes(x = borough, fill = above_hosp_median)
  ) + 
  geom_bar(position = "fill")

above_below_puma %>% 
  group_by(borough) %>% 
  ggplot(
    aes(x = borough, fill = above_death_median)
  ) + 
  geom_bar(position = "fill")

above_below_puma %>% 
  group_by(borough) %>% 
  ggplot(
    aes(x = borough, fill = above_vax_median)
  ) + 
  geom_bar(position = "fill")
  
```

Outcomes by PUMA population size

```{r}
puma_group = cleaned_data %>% 
  group_by(puma) %>% 
  summarize(
    people = sum(perwt),
    median_hosp_rate = median(puma_hosp_rate),
    median_death_rate = median(puma_death_rate),
    median_vax_rate = median(puma_vacc_rate)
  )

puma_group %>% 
  ggplot(aes(x = people, y = median_hosp_rate)) + 
  geom_point() + 
  geom_smooth()

puma_group %>% 
  ggplot(aes(x = people, y = median_death_rate)) + 
  geom_point() + 
  geom_smooth()

puma_group %>% 
  ggplot(aes(x = people, y = median_vax_rate)) + 
  geom_point() + 
  geom_smooth()
  
```

Top 10 best and worst PUMAs for each outcome (here, using hospitalization as an example)

```{r}
nyc_puma_summary_counties %>% 
  arrange(desc(covid_hosp_rate)) %>% 
  mutate(
    rank = rank(desc(covid_hosp_rate))
  ) %>% 
  filter(rank < 11) %>% 
  ggplot(aes(x = fct_reorder(puma, desc(covid_hosp_rate)), y = covid_hosp_rate)) + 
  geom_bar(stat = "identity", aes(fill = borough))

nyc_puma_summary_counties %>% 
  arrange(desc(covid_death_rate)) %>% 
  mutate(
    rank = rank(desc(covid_death_rate))
  ) %>% 
  filter(rank < 11) %>% 
  ggplot(aes(x = fct_reorder(puma, desc(covid_death_rate)), y = covid_death_rate)) + 
  geom_bar(stat = "identity", aes(fill = borough))

nyc_puma_summary_counties %>% 
  arrange(desc(covid_vax_rate)) %>% 
  mutate(
    rank = rank(desc(covid_vax_rate))
  ) %>% 
  filter(rank < 11) %>% 
  ggplot(aes(x = fct_reorder(puma, desc(covid_vax_rate)), y = covid_vax_rate)) + 
  geom_bar(stat = "identity", aes(fill = borough))
```

